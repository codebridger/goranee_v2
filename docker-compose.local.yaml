services:
  nginx:
    build:
      context: .
      dockerfile: nginx.Dockerfile.local
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/certbot:/var/www/certbot:ro
    depends_on:
      server:
        condition: service_healthy
      end_user:
        condition: service_started
    networks:
      - default

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    restart: always
    expose:
      - "8081"
    volumes:
      - ./server/uploads:/server/uploads
      - ./server/backups:/server/backups
    env_file:
      - .env
    environment:
      - ADMIN_EMAIL=${SERVER_ADMIN_EMAIL:-admin@mail.com}
      - ADMIN_PASSWORD=${SERVER_ADMIN_PASSWORD:-admin}
      - NODE_ENV=${NODE_ENV:-development}
      - MONGODB_URL=${MONGODB_URL:-mongodb://mongo:27017}
    depends_on:
      mongo:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:8081/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - default

  end_user:
    build:
      context: ./end_user
      dockerfile: Dockerfile
    restart: always
    expose:
      - "8080"
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - NUXT_API_BASE_URL=/api/
      - PORT=8080
      - NITRO_PORT=8080
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:8080', (r) => {process.exit(r.statusCode < 500 ? 0 : 1)}).on('error', () => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - default

  mongo:
    image: ghcr.io/navidshad/chord_library_mongodb:4.4.28
    # Fallback to official MongoDB if GHCR image is not available locally
    # Uncomment the line below if you don't have access to GHCR image
    # image: mongo:4.4.28
    volumes:
      - ./database_data:/data/db
    restart: always
    networks:
      - default
