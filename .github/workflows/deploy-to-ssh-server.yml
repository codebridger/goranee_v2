# Steps to deploy the app:
# - Build the Docker images and push them to GitHub Container Registry
# - Deploy the Docker images to server by SSH

name: Deploy To SSH Server

on:
  push:
    branches: ["main"]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_TAG_SERVER: SERVER-${{ github.sha }}
  IMAGE_TAG_END_USER: END_USER-${{ github.sha }}
  REGISTRY: ghcr.io
  IMAGE_NAME: navidshad/goranee_v2

jobs:
  cleanup-old-images:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old package versions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const packages = [
              'goranee_v2_server',
              'goranee_v2_end_user',
              'goranee_v2_nginx'
            ];

            const keepVersions = 10; // Keep the latest 10 versions

            for (const packageName of packages) {
              try {
                // Get all package versions
                const { data: versions } = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                  package_type: 'container',
                  package_name: packageName,
                  username: context.repo.owner,
                  per_page: 100
                });
                
                if (!versions || versions.length === 0) {
                  console.log(`No versions found for ${packageName}`);
                  continue;
                }
                
                // Filter out 'latest' tag and sort by creation date (newest first)
                const sortedVersions = versions
                  .filter(v => {
                    const tags = v.metadata?.container?.tags || [];
                    return !tags.includes('latest');
                  })
                  .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Delete versions beyond the keep limit
                const versionsToDelete = sortedVersions.slice(keepVersions);
                
                console.log(`Processing ${packageName}: ${sortedVersions.length} versions found, keeping ${Math.min(keepVersions, sortedVersions.length)}, deleting ${versionsToDelete.length}`);
                
                for (const version of versionsToDelete) {
                  try {
                    await github.rest.packages.deletePackageVersionForUser({
                      package_type: 'container',
                      package_name: packageName,
                      username: context.repo.owner,
                      package_version_id: version.id
                    });
                    console.log(`✓ Deleted ${packageName} version ${version.id} (${version.name || 'untagged'})`);
                  } catch (error) {
                    console.log(`✗ Failed to delete ${packageName} version ${version.id}: ${error.message}`);
                  }
                }
              } catch (error) {
                // Package might not exist yet, which is fine
                if (error.status === 404) {
                  console.log(`Package ${packageName} does not exist yet, skipping cleanup`);
                } else {
                  console.log(`Error processing ${packageName}: ${error.message}`);
                }
              }
            }

  build-nginx:
    runs-on: ubuntu-latest
    needs: cleanup-old-images
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 14

      - name: Build admin panel static files
        run: |
          cd admin_panel
          echo "VUE_APP_BASE_URL=/api/" > .env
          echo "VUE_APP_BASE_URL_ON_SERVER=http://localhost:8081/" >> .env
          npm install
          npm run generate

      - name: Link package to repository (if needed)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.packages.linkPackageToRepository({
                package_type: 'container',
                package_name: 'goranee_v2_nginx',
                username: context.repo.owner,
                repository_id: context.repo.id
              });
              console.log('Package linked to repository');
            } catch (error) {
              // Package might not exist yet or already linked, which is fine
              console.log(`Package link check: ${error.message}`);
            }

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Nginx Image
        id: push-nginx
        continue-on-error: true
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}_nginx:latest -f nginx.Dockerfile .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}_nginx:latest
        working-directory: .

      - name: Link package to repository (if push failed)
        if: steps.push-nginx.outcome == 'failure'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Get repository ID
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              // Try to link package to repository
              await github.rest.packages.linkPackageToRepository({
                package_type: 'container',
                package_name: 'goranee_v2_nginx',
                username: context.repo.owner,
                repository_id: repo.id
              });
              
              console.log('Package linked to repository. Please retry the workflow.');
            } catch (error) {
              console.log('⚠️ Package linking failed. Please manually link the package:');
              console.log('1. Go to https://github.com/' + context.repo.owner + '?tab=packages');
              console.log('2. Find package: goranee_v2_nginx');
              console.log('3. Go to Package settings > Manage Actions access');
              console.log('4. Add repository: ' + context.repo.owner + '/' + context.repo.repo + ' with Write access');
              console.log('Error: ' + error.message);
            }

  build-server:
    runs-on: ubuntu-latest
    needs: cleanup-old-images
    steps:
      - uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Server Image
        id: push-server
        continue-on-error: true
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}_server:${{ env.IMAGE_TAG_SERVER }} -f server/Dockerfile ./server
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}_server:${{ env.IMAGE_TAG_SERVER }}

      - name: Link package to repository (if push failed)
        if: steps.push-server.outcome == 'failure'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Get repository ID
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              // Try to link package to repository
              await github.rest.packages.linkPackageToRepository({
                package_type: 'container',
                package_name: 'goranee_v2_server',
                username: context.repo.owner,
                repository_id: repo.id
              });
              
              console.log('Package linked to repository. Please retry the workflow.');
            } catch (error) {
              console.log('⚠️ Package linking failed. Please manually link the package:');
              console.log('1. Go to https://github.com/' + context.repo.owner + '?tab=packages');
              console.log('2. Find package: goranee_v2_server');
              console.log('3. Go to Package settings > Manage Actions access');
              console.log('4. Add repository: ' + context.repo.owner + '/' + context.repo.repo + ' with Write access');
              console.log('Error: ' + error.message);
            }

  build-end-user:
    runs-on: ubuntu-latest
    needs: cleanup-old-images
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Build end_user app
        run: |
          cd end_user
          echo "NUXT_API_BASE_URL=/api/" > .env
          npm install
          npm run build

      - name: Link package to repository (if needed)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.packages.linkPackageToRepository({
                package_type: 'container',
                package_name: 'goranee_v2_end_user',
                username: context.repo.owner,
                repository_id: context.repo.id
              });
              console.log('Package linked to repository');
            } catch (error) {
              // Package might not exist yet or already linked, which is fine
              console.log(`Package link check: ${error.message}`);
            }

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push End User Image
        id: push-end-user
        continue-on-error: true
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}_end_user:${{ env.IMAGE_TAG_END_USER }} -f end_user/Dockerfile ./end_user
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}_end_user:${{ env.IMAGE_TAG_END_USER }}

      - name: Link package to repository (if push failed)
        if: steps.push-end-user.outcome == 'failure'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Get repository ID
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              // Try to link package to repository
              await github.rest.packages.linkPackageToRepository({
                package_type: 'container',
                package_name: 'goranee_v2_end_user',
                username: context.repo.owner,
                repository_id: repo.id
              });
              
              console.log('Package linked to repository. Please retry the workflow.');
            } catch (error) {
              console.log('⚠️ Package linking failed. Please manually link the package:');
              console.log('1. Go to https://github.com/' + context.repo.owner + '?tab=packages');
              console.log('2. Find package: goranee_v2_end_user');
              console.log('3. Go to Package settings > Manage Actions access');
              console.log('4. Add repository: ' + context.repo.owner + '/' + context.repo.repo + ' with Write access');
              console.log('Error: ' + error.message);
            }

  deploy:
    runs-on: ubuntu-latest
    needs: [build-server, build-end-user, build-nginx]
    if: always() && (needs.build-server.result == 'success' || needs.build-server.result == 'skipped') && (needs.build-end-user.result == 'success' || needs.build-end-user.result == 'skipped') && (needs.build-nginx.result == 'success' || needs.build-nginx.result == 'skipped')
    steps:
      - uses: actions/checkout@v3

      - name: Copy docker-compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "docker-compose.yaml"
          target: "."
          timeout: 30s

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        env:
          SERVER_IMAGE_TAG: ${{ env.IMAGE_TAG_SERVER }}
          END_USER_IMAGE_TAG: ${{ env.IMAGE_TAG_END_USER }}
          SERVER_ADMIN_EMAIL: ${{ secrets.SERVER_ADMIN_EMAIL }}
          SERVER_ADMIN_PASSWORD: ${{ secrets.SERVER_ADMIN_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          envs: SERVER_IMAGE_TAG, END_USER_IMAGE_TAG, SERVER_ADMIN_EMAIL, SERVER_ADMIN_PASSWORD, GITHUB_TOKEN, GITHUB_ACTOR, GITHUB_SHA
          script: |
            # Login to GitHub Container Registry
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin || true

            # Set image tags (use commit SHA tags or fallback to latest)
            export SERVER_IMAGE_TAG=${SERVER_IMAGE_TAG:-SERVER-${GITHUB_SHA:-latest}}
            export END_USER_IMAGE_TAG=${END_USER_IMAGE_TAG:-END_USER-${GITHUB_SHA:-latest}}
            export NGINX_IMAGE_TAG=latest

            # Remove the previous version of the app, if exists
            docker-compose down

            # Pull latest images first
            docker-compose pull

            # Start the new version
            docker-compose up --remove-orphans -d

            # Clean up unused images to save space
            # Remove old SHA-tagged images from this project (keep only current deployment)
            OLD_SERVER_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "ghcr.io/navidshad/goranee_v2_server" | grep "SERVER-" | grep -v "$SERVER_IMAGE_TAG" || true)
            OLD_END_USER_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "ghcr.io/navidshad/goranee_v2_end_user" | grep "END_USER-" | grep -v "$END_USER_IMAGE_TAG" || true)

            if [ -n "$OLD_SERVER_IMAGES" ]; then
              echo "$OLD_SERVER_IMAGES" | xargs docker rmi -f || true
            fi
            if [ -n "$OLD_END_USER_IMAGES" ]; then
              echo "$OLD_END_USER_IMAGES" | xargs docker rmi -f || true
            fi

            # Remove all dangling images and unused build cache
            docker image prune -a -f
            docker builder prune -a -f

            # Remove all stopped containers and unused networks
            docker container prune -f
            docker network prune -f
